name: Update DoD Certificate Bundle

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download DoD certificates
        run: |
          mkdir -p certs
          BASE_URL="https://militarycac.com"

          # Download all 35 certificates
          # Derility CA certificates
          curl -L -o certs/DoD_Derility_CA-1.p7b "${BASE_URL}/chromecerts/DoD_Derility_CA-1.p7b"
          curl -L -o certs/DoD_Derility_CA-3.p7b "${BASE_URL}/chromecerts/DoD_Derility_CA-3.p7b"
          curl -L -o certs/DoD_Derility_CA-4.p7b "${BASE_URL}/chromecerts/DoD_Derility_CA-4.p7b"

          # Email CA certificates
          curl -L -o certs/DOD_EMAIL_CA-59.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-59.p7b"
          curl -L -o certs/DOD_EMAIL_CA-62.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-62.p7b"
          curl -L -o certs/DOD_EMAIL_CA-63.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-63.p7b"
          curl -L -o certs/DOD_EMAIL_CA-64.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-64.p7b"
          curl -L -o certs/DOD_EMAIL_CA-65.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-65.p7b"
          curl -L -o certs/DOD_EMAIL_CA-70.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-70.p7b"
          curl -L -o certs/DOD_EMAIL_CA-71.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-71.p7b"
          curl -L -o certs/DOD_EMAIL_CA-72.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-72.p7b"
          curl -L -o certs/DOD_EMAIL_CA-73.p7b "${BASE_URL}/chromecerts/DOD_EMAIL_CA-73.p7b"

          # ID CA certificates
          curl -L -o certs/DOD_ID_CA-59.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-59.p7b"
          curl -L -o certs/DOD_ID_CA-62.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-62.p7b"
          curl -L -o certs/DOD_ID_CA-63.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-63.p7b"
          curl -L -o certs/DOD_ID_CA-64.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-64.p7b"
          curl -L -o certs/DOD_ID_CA-65.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-65.p7b"
          curl -L -o certs/DOD_ID_CA-70.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-70.p7b"
          curl -L -o certs/DOD_ID_CA-71.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-71.p7b"
          curl -L -o certs/DOD_ID_CA-72.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-72.p7b"
          curl -L -o certs/DOD_ID_CA-73.p7b "${BASE_URL}/chromecerts/DOD_ID_CA-73.p7b"

          # Root certificates
          curl -L -o certs/RootCert3.p7b "${BASE_URL}/maccerts/RootCert3.p7b"
          curl -L -o certs/RootCert4.p7b "${BASE_URL}/maccerts/RootCert4.p7b"
          curl -L -o certs/RootCert5.p7b "${BASE_URL}/maccerts/RootCert5.p7b"
          curl -L -o certs/RootCert6.p7b "${BASE_URL}/maccerts/RootCert6.p7b"

          # Software CA certificates
          curl -L -o certs/DOD_SW_CA-60.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-60.p7b"
          curl -L -o certs/DOD_SW_CA-61.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-61.p7b"
          curl -L -o certs/DOD_SW_CA-66.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-66.p7b"
          curl -L -o certs/DOD_SW_CA-67.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-67.p7b"
          curl -L -o certs/DOD_SW_CA-68.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-68.p7b"
          curl -L -o certs/DOD_SW_CA-69.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-69.p7b"
          curl -L -o certs/DOD_SW_CA-74.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-74.p7b"
          curl -L -o certs/DOD_SW_CA-75.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-75.p7b"
          curl -L -o certs/DOD_SW_CA-76.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-76.p7b"
          curl -L -o certs/DOD_SW_CA-77.p7b "${BASE_URL}/chromecerts/DOD_SW_CA-77.p7b"

      - name: Convert certificates to bundle
        run: |
          cd certs
          echo -n > dod-cert-bundle.crt

          # Convert all P7B files to PEM format
          for p7b in *.p7b; do
            echo "Converting ${p7b} to PEM format"
            # P7B files can contain multiple certificates, extract them all
            openssl pkcs7 -inform PEM -outform PEM -in "${p7b}" -print_certs >> dod-cert-bundle.crt 2>/dev/null || \
            openssl pkcs7 -inform DER -outform PEM -in "${p7b}" -print_certs >> dod-cert-bundle.crt 2>/dev/null || \
            echo "Failed to convert ${p7b}"
            echo "" >> dod-cert-bundle.crt
          done

          mv dod-cert-bundle.crt ../

      - name: Generate release tag and date
        id: release_info
        run: |
          # Format: MM_DD_YYYY-HH_MM
          TAG=$(date -u +'%m_%d_%Y-%H_%M')
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Human readable format
          READABLE_DATE=$(date -u +'%B %d, %Y')
          READABLE_TIME=$(date -u +'%H:%M')
          echo "readable_date=$READABLE_DATE" >> $GITHUB_OUTPUT
          echo "readable_time=$READABLE_TIME" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.release_info.outputs.tag }}" \
            --title "DoD Certificate Bundle ${{ steps.release_info.outputs.tag }}" \
            --notes "# DoD Certificate Bundle

          This release was made on **${{ steps.release_info.outputs.readable_date }}** at **${{ steps.release_info.outputs.readable_time }}** UTC.

          This bundle contains all DoD CA certificates converted to PEM format.

          ## Usage
          Download \`dod-cert-bundle.crt\` and use it in your applications that need to trust DoD certificates." \
            dod-cert-bundle.crt
