name: Update DoD Certificate Bundle

on:
  # Run daily at 00:00 UTC
  schedule:
    - cron: '0 0 * * *'
  # Run on pushes to 'main'
  push:
    branches:
      - main
  # Allow manual trigger
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Create certificate bundle
        run: |
          echo -n > dod-cert-bundle.crt

          # Concatenate all .crt files from the certs directory
          for crt in certs/*.crt; do
            echo "Adding ${crt} to bundle"
            cat "${crt}" >> dod-cert-bundle.crt
            echo "" >> dod-cert-bundle.crt
          done

      - name: Generate release tag and date
        id: release_info
        run: |
          # Format: MM_DD_YYYY-HH_MM
          TAG=$(date -u +'%m_%d_%Y-%H_%M')
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Human readable format
          READABLE_DATE=$(date -u +'%B %d, %Y')
          READABLE_TIME=$(date -u +'%H:%M')
          echo "readable_date=$READABLE_DATE" >> $GITHUB_OUTPUT
          echo "readable_time=$READABLE_TIME" >> $GITHUB_OUTPUT

      - name: Create Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create "${{ steps.release_info.outputs.tag }}" \
            --title "DoD Certificate Bundle ${{ steps.release_info.outputs.tag }}" \
            --notes "# DoD Certificate Bundle

          This release was made on **${{ steps.release_info.outputs.readable_date }}** at **${{ steps.release_info.outputs.readable_time }}** UTC.

          This bundle contains all DoD CA certificates converted to PEM format.

          ## Usage
          Download \`dod-cert-bundle.crt\` and use it in your applications that need to trust DoD certificates." \
            dod-cert-bundle.crt
